# 管理後台使用說明

## 概述

管理後台是一個網頁介面，用於檢視和管理 LINE Bot 的所有對話紀錄和訊息。提供完整的篩選、搜尋和即時更新功能。

## 訪問方式

### 本地開發環境

1. 確保開發伺服器正在運行：
   ```bash
   npm run dev
   ```

2. 在瀏覽器中訪問：
   ```
   http://localhost:3000/admin
   ```

### 生產環境

訪問部署後的網址：
```
https://your-domain.com/admin
```

## 功能說明

### 1. 對話列表檢視

管理後台主頁面會顯示所有對話的列表，包含以下資訊：

- **使用者 ID**：LINE 使用者的唯一識別碼
- **標題**：對話標題（如果有的話）
- **訊息數**：該對話中的訊息總數
- **建立時間**：對話建立的時間
- **最後更新**：對話最後更新的時間

### 2. 篩選功能

#### 依使用者 ID 篩選

1. 在「使用者 ID」輸入框中輸入要查詢的使用者 ID
2. 點擊「套用篩選」按鈕
3. 系統會只顯示該使用者的對話

#### 依時間範圍篩選

1. 在「開始日期」選擇開始日期
2. 在「結束日期」選擇結束日期
3. 點擊「套用篩選」按鈕
4. 系統會只顯示在指定時間範圍內建立的對話

**注意**：可以只選擇開始日期或結束日期，也可以兩者都選擇。

#### 依對話搜尋

1. 在「搜尋對話」輸入框中輸入關鍵字
2. 點擊「套用篩選」按鈕
3. 系統會搜尋：
   - 對話標題中包含關鍵字的對話
   - 訊息內容中包含關鍵字的對話

**搜尋特點**：
- 不區分大小寫
- 支援部分匹配
- 會搜尋所有訊息的內容

#### 重置篩選條件

點擊「重置」按鈕可以清除所有篩選條件，恢復顯示所有對話。

### 3. 訊息詳情檢視

1. 在對話列表中，點擊想要查看的對話列
2. 對話會展開，顯示該對話的所有訊息
3. 訊息會按照時間順序排列（從舊到新）
4. 每個訊息會顯示：
   - **角色**：使用者（user）、助理（assistant）或系統（system）
   - **內容**：訊息的完整內容
   - **時間戳記**：訊息發送的時間

**訊息顏色標示**：
- 🔵 藍色：使用者訊息
- 🟢 綠色：助理（AI）訊息
- ⚪ 灰色：系統訊息

### 4. 分頁功能

當對話數量較多時，系統會自動分頁：

- **每頁顯示**：20 筆對話（預設）
- **分頁控制**：位於對話列表底部
- **功能**：
  - 點擊「上一頁」查看前一頁
  - 點擊「下一頁」查看下一頁
  - 顯示當前頁碼和總頁數

### 5. 即時更新功能

管理後台支援自動更新功能：

- **自動更新開關**：位於控制面板左側
- **更新頻率**：每 5 秒自動刷新一次
- **最後更新時間**：顯示在控制面板中
- **手動刷新**：關閉自動更新後，可以手動點擊「套用篩選」來刷新

**使用建議**：
- 在監控新訊息時，建議開啟自動更新
- 在查看歷史紀錄時，可以關閉自動更新以節省資源

## API 端點說明

管理後台使用以下 API 端點：

### 1. 取得對話列表

**端點**：`GET /api/admin/conversations`

**查詢參數**：

| 參數 | 類型 | 必填 | 說明 |
|------|------|------|------|
| `userId` | string | 否 | 使用者 ID 篩選 |
| `startDate` | string | 否 | 開始日期（ISO 格式，如：2024-01-01T00:00:00.000Z） |
| `endDate` | string | 否 | 結束日期（ISO 格式） |
| `search` | string | 否 | 搜尋關鍵字（標題或內容） |
| `page` | number | 否 | 頁碼（預設：1） |
| `limit` | number | 否 | 每頁數量（預設：20，最大：100） |

**回應格式**：

```json
{
  "conversations": [
    {
      "_id": "對話ID",
      "userId": "使用者ID",
      "title": "對話標題",
      "messageCount": 10,
      "createdAt": "2024-01-01T00:00:00.000Z",
      "updatedAt": "2024-01-01T00:00:00.000Z"
    }
  ],
  "total": 100,
  "page": 1,
  "limit": 20,
  "totalPages": 5
}
```

**範例請求**：

```bash
# 取得所有對話
curl http://localhost:3000/api/admin/conversations

# 依使用者 ID 篩選
curl "http://localhost:3000/api/admin/conversations?userId=U1234567890"

# 依時間範圍篩選
curl "http://localhost:3000/api/admin/conversations?startDate=2024-01-01T00:00:00.000Z&endDate=2024-01-31T23:59:59.999Z"

# 搜尋對話
curl "http://localhost:3000/api/admin/conversations?search=關鍵字"

# 分頁查詢
curl "http://localhost:3000/api/admin/conversations?page=2&limit=10"
```

### 2. 取得訊息列表

**端點**：`GET /api/admin/messages`

**查詢參數**：

| 參數 | 類型 | 必填 | 說明 |
|------|------|------|------|
| `conversationId` | string | 是 | 對話 ID |
| `page` | number | 否 | 頁碼（預設：1） |
| `limit` | number | 否 | 每頁數量（預設：50，最大：100） |

**回應格式**：

```json
{
  "messages": [
    {
      "_id": "訊息ID",
      "conversationId": "對話ID",
      "userId": "使用者ID",
      "role": "user",
      "content": "訊息內容",
      "timestamp": "2024-01-01T00:00:00.000Z",
      "createdAt": "2024-01-01T00:00:00.000Z",
      "updatedAt": "2024-01-01T00:00:00.000Z"
    }
  ],
  "total": 50,
  "page": 1,
  "limit": 50,
  "totalPages": 1
}
```

**範例請求**：

```bash
# 取得對話的所有訊息
curl "http://localhost:3000/api/admin/messages?conversationId=507f1f77bcf86cd799439011"

# 分頁查詢訊息
curl "http://localhost:3000/api/admin/messages?conversationId=507f1f77bcf86cd799439011&page=1&limit=20"
```

## 使用流程範例

### 範例 1：查看特定使用者的所有對話

1. 在「使用者 ID」輸入框中輸入使用者 ID（例如：`U1234567890`）
2. 點擊「套用篩選」
3. 系統會顯示該使用者的所有對話
4. 點擊對話列可以查看該對話的詳細訊息

### 範例 2：查看今天的所有對話

1. 在「開始日期」選擇今天的日期
2. 在「結束日期」選擇今天的日期
3. 點擊「套用篩選」
4. 系統會顯示今天建立的所有對話

### 範例 3：搜尋包含特定關鍵字的對話

1. 在「搜尋對話」輸入框中輸入關鍵字（例如：`天氣`）
2. 點擊「套用篩選」
3. 系統會顯示標題或訊息內容中包含「天氣」的所有對話
4. 展開對話可以查看具體哪些訊息包含該關鍵字

### 範例 4：監控新訊息

1. 開啟「自動更新」開關
2. 系統會每 5 秒自動刷新對話列表
3. 新的對話和訊息會自動顯示在列表中
4. 可以隨時查看「最後更新」時間來確認系統是否正常運作

## 技術細節

### 前端技術

- **框架**：Next.js 14 (App Router)
- **語言**：TypeScript
- **樣式**：Tailwind CSS
- **狀態管理**：React Hooks (useState, useEffect)
- **即時更新**：Polling（每 5 秒）

### 後端技術

- **API 路由**：Next.js Route Handlers
- **資料庫**：MongoDB (Mongoose)
- **查詢優化**：使用索引提高查詢效能

### 資料庫結構

- **Conversations 集合**：儲存對話資訊
- **Messages 集合**：儲存訊息內容
- **索引**：已為常用查詢欄位建立索引（userId, conversationId, timestamp）

## 注意事項

1. **效能考量**：
   - 當對話數量很大時，建議使用篩選功能縮小查詢範圍
   - 自動更新功能會持續向伺服器發送請求，請適度使用

2. **資料安全**：
   - 管理後台目前沒有身份驗證機制
   - 建議在生產環境中加入身份驗證（例如：登入功能）

3. **瀏覽器相容性**：
   - 建議使用現代瀏覽器（Chrome、Firefox、Safari、Edge）
   - 不支援 Internet Explorer

4. **時間格式**：
   - 所有時間顯示為台灣時間（zh-TW）
   - API 返回的時間為 ISO 8601 格式（UTC）

## 疑難排解

### 問題：無法載入對話列表

**可能原因**：
- 資料庫連接失敗
- API 端點錯誤

**解決方法**：
1. 檢查瀏覽器開發者工具的 Console 和 Network 標籤
2. 確認 MongoDB 連接正常
3. 檢查伺服器日誌

### 問題：篩選功能沒有反應

**可能原因**：
- 沒有點擊「套用篩選」按鈕
- 篩選條件沒有匹配的結果

**解決方法**：
1. 確認已點擊「套用篩選」按鈕
2. 檢查篩選條件是否正確
3. 嘗試重置篩選條件後重新設定

### 問題：自動更新沒有運作

**可能原因**：
- 自動更新開關被關閉
- 瀏覽器標籤頁處於背景狀態（某些瀏覽器會暫停 JavaScript）

**解決方法**：
1. 確認自動更新開關已開啟
2. 將瀏覽器標籤頁保持在前景
3. 手動點擊「套用篩選」來刷新

## 未來改進建議

1. **身份驗證**：加入登入功能，保護管理後台
2. **權限管理**：不同角色有不同的操作權限
3. **匯出功能**：匯出對話紀錄為 CSV 或 JSON
4. **統計圖表**：顯示對話數量、訊息數量等統計資訊
5. **即時通知**：使用 WebSocket 或 SSE 實現真正的即時更新
6. **批量操作**：支援批量刪除對話或訊息
7. **進階搜尋**：支援正則表達式、多關鍵字搜尋等

## 相關檔案

- 管理後台頁面：`app/admin/page.tsx`
- 對話列表 API：`app/api/admin/conversations/route.ts`
- 訊息列表 API：`app/api/admin/messages/route.ts`
- 資料庫服務：`lib/db-service.ts`
- 資料模型：`lib/models/Conversation.ts`、`lib/models/Message.ts`

